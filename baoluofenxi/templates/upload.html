{% extends "base.html" %}

{% block title %}数据上传 - {{ experiment_type.name }}{% endblock %}

{% block extra_head %}
<style>
.upload-container {
    max-width: 800px;
    margin: 0 auto;
}

.upload-area {
    border: 3px dashed #007bff;
    border-radius: 15px;
    padding: 40px;
    text-align: center;
    background-color: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.upload-area:hover {
    border-color: #0056b3;
    background-color: #e9ecef;
}

.upload-area.dragover {
    border-color: #28a745;
    background-color: #d4edda;
    transform: scale(1.02);
}

.upload-icon {
    font-size: 3rem;
    color: #6c757d;
    margin-bottom: 1rem;
}

.file-info {
    background-color: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
}

.progress-container {
    display: none;
    margin-top: 1rem;
}

.data-preview {
    max-height: 300px;
    overflow-y: auto;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 1rem;
    margin-top: 1rem;
}

.validation-result {
    margin-top: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <!-- 页面头部 -->
    <div class="card mb-4">
        <div class="card-header">
            <h4 class="mb-0">
                <i class="fas fa-cloud-upload-alt me-2"></i>
                数据上传 - {{ experiment_type.name }}
            </h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>试验类型：</strong>{{ experiment_type.name }}</p>
                    <p><strong>描述：</strong>{{ experiment_type.description or '暂无描述' }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>时间列：</strong>{{ experiment_type.time_column }}</p>
                    <p><strong>数据列：</strong>{{ experiment_type.data_columns | join(', ') }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 上传区域 -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-file-upload me-2"></i>选择文件上传
            </h5>
        </div>
        <div class="card-body">
            <form id="uploadForm" method="post" enctype="multipart/form-data">
                <!-- 文件拖拽区域 -->
                <div class="upload-area" id="uploadArea">
                    <div class="upload-content">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <h5>将文件拖拽到此处或点击选择</h5>
                        <p class="text-muted mb-0">支持 CSV、Excel (.xlsx, .xls) 文件</p>
                        <small class="text-muted">最大文件大小：16MB</small>
                    </div>
                </div>

                <!-- 隐藏的文件输入 -->
                <input type="file" id="fileInput" name="file" class="d-none" 
                       accept=".csv,.xlsx,.xls" required>

                <!-- 文件信息显示 -->
                <div id="fileInfo" class="file-info d-none">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 id="fileName" class="mb-1"></h6>
                            <small id="fileDetails" class="text-muted"></small>
                        </div>
                        <div class="col-md-4 text-end">
                            <button type="button" class="btn btn-outline-danger btn-sm" id="removeFile">
                                <i class="fas fa-times me-1"></i>移除
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 数据名称输入 -->
                <div class="row mt-3">
                    <div class="col-md-8">
                        <label for="dataName" class="form-label">数据名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="dataName" name="data_name" 
                               placeholder="请输入一个描述性的数据名称..." required>
                        <div class="form-text">用于标识此次上传的数据，方便后续管理</div>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" class="btn btn-primary w-100" id="previewBtn" disabled>
                            <i class="fas fa-eye me-1"></i>预览数据
                        </button>
                    </div>
                </div>

                <!-- 进度条 -->
                <div class="progress-container">
                    <div class="d-flex justify-content-between mb-1">
                        <small class="text-muted">上传进度</small>
                        <small class="text-muted" id="progressText">0%</small>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" role="progressbar" 
                             style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>

                <!-- 数据预览区域 -->
                <div id="dataPreviewContainer" class="d-none">
                    <h6 class="mt-3 mb-2">数据预览</h6>
                    <div class="data-preview">
                        <div id="dataPreview"></div>
                    </div>
                    
                    <!-- 验证结果 -->
                    <div id="validationResult" class="validation-result"></div>
                </div>

                <!-- 提交按钮 -->
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-success btn-lg" id="uploadBtn" disabled>
                        <i class="fas fa-upload me-2"></i>上传数据
                    </button>
                    <a href="{{ url_for('envelope_analysis', experiment_type_id=experiment_type.id) }}" 
                       class="btn btn-outline-secondary btn-lg ms-2">
                        <i class="fas fa-chart-line me-2"></i>返回分析
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- 上传历史 -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-history me-2"></i>最近上传
            </h5>
        </div>
        <div class="card-body">
            {% if recent_uploads %}
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>数据名称</th>
                            <th>文件名</th>
                            <th>行数</th>
                            <th>上传时间</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for data in recent_uploads %}
                        <tr>
                            <td>{{ data.data_name }}</td>
                            <td>{{ data.file_name }}</td>
                            <td>{{ data.row_count }}</td>
                            <td>{{ data.upload_time.strftime('%m-%d %H:%M') }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if data.status == 'active' else 'secondary' }}">
                                    {{ '正常' if data.status == 'active' else '已删除' }}
                                </span>
                            </td>
                            <td>
                                <a href="{{ url_for('data_detail', data_id=data.id) }}" 
                                   class="btn btn-outline-primary btn-sm">查看</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>暂无上传记录</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    const uploadArea = $('#uploadArea');
    const fileInput = $('#fileInput');
    const fileInfo = $('#fileInfo');
    const fileName = $('#fileName');
    const fileDetails = $('#fileDetails');
    const dataName = $('#dataName');
    const previewBtn = $('#previewBtn');
    const uploadBtn = $('#uploadBtn');
    const uploadForm = $('#uploadForm');
    const removeFileBtn = $('#removeFile');

    // 拖拽上传
    uploadArea.on('dragover dragenter', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).addClass('dragover');
    });

    uploadArea.on('dragleave dragend', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).removeClass('dragover');
    });

    uploadArea.on('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).removeClass('dragover');
        
        const files = e.originalEvent.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });

    // 点击上传区域
    uploadArea.on('click', function() {
        fileInput.click();
    });

    // 文件选择
    fileInput.on('change', function() {
        if (this.files.length > 0) {
            handleFileSelect(this.files[0]);
        }
    });

    // 移除文件
    removeFileBtn.on('click', function() {
        resetFileSelection();
    });

    // 预览按钮
    previewBtn.on('click', function() {
        previewData();
    });

    // 表单提交
    uploadForm.on('submit', function(e) {
        e.preventDefault();
        uploadFile();
    });

    // 处理文件选择
    function handleFileSelect(file) {
        // 验证文件类型
        const allowedTypes = ['.csv', '.xlsx', '.xls'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!allowedTypes.includes(fileExtension)) {
            showAlert('不支持的文件类型。请选择 CSV 或 Excel 文件。', 'danger');
            return;
        }

        // 验证文件大小 (16MB)
        if (file.size > 16 * 1024 * 1024) {
            showAlert('文件太大。请选择小于 16MB 的文件。', 'danger');
            return;
        }

        // 显示文件信息
        fileName.text(file.name);
        fileDetails.html(`
            <i class="fas fa-file-alt me-1"></i>
            大小: ${formatFileSize(file.size)} | 
            类型: ${file.type || '未知'} | 
            修改时间: ${new Date(file.lastModified).toLocaleString()}
        `);
        
        fileInfo.removeClass('d-none');
        previewBtn.prop('disabled', false);
        
        // 生成默认数据名称
        if (!dataName.val()) {
            const baseName = file.name.replace(/\.[^/.]+$/, '');
            const timestamp = new Date().toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(/[/:]/g, '-');
            dataName.val(`${baseName}_${timestamp}`);
        }

        updateUploadButton();
    }

    // 重置文件选择
    function resetFileSelection() {
        fileInput.val('');
        fileInfo.addClass('d-none');
        previewBtn.prop('disabled', true);
        $('#dataPreviewContainer').addClass('d-none');
        updateUploadButton();
    }

    // 更新上传按钮状态
    function updateUploadButton() {
        const hasFile = fileInput[0].files.length > 0;
        const hasDataName = dataName.val().trim().length > 0;
        uploadBtn.prop('disabled', !(hasFile && hasDataName));
    }

    // 数据预览
    function previewData() {
        const file = fileInput[0].files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        showProgress('正在预览数据...', 30);

        $.ajax({
            url: '/api/preview/{{ experiment_type.id }}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                hideProgress();
                if (response.success) {
                    displayPreview(response.data);
                    displayValidation(response.validation);
                } else {
                    showAlert(response.message || '预览失败', 'danger');
                }
            },
            error: function() {
                hideProgress();
                showAlert('网络错误，预览失败', 'danger');
            }
        });
    }

    // 显示数据预览
    function displayPreview(data) {
        if (!data || !data.headers || !data.rows) return;

        let html = '<div class="table-responsive"><table class="table table-sm table-striped">';
        
        // 表头
        html += '<thead><tr>';
        data.headers.forEach(header => {
            html += `<th>${header}</th>`;
        });
        html += '</tr></thead>';

        // 数据行（最多显示10行）
        html += '<tbody>';
        data.rows.slice(0, 10).forEach(row => {
            html += '<tr>';
            row.forEach(cell => {
                html += `<td>${cell}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table></div>';

        if (data.rows.length > 10) {
            html += `<small class="text-muted">显示前10行，共${data.total_rows}行数据</small>`;
        }

        $('#dataPreview').html(html);
        $('#dataPreviewContainer').removeClass('d-none');
    }

    // 显示验证结果
    function displayValidation(validation) {
        if (!validation) return;

        let html = '';
        let alertClass = 'success';

        if (validation.errors && validation.errors.length > 0) {
            alertClass = 'danger';
            html += '<div class="alert alert-danger"><h6>数据验证失败：</h6><ul class="mb-0">';
            validation.errors.forEach(error => {
                html += `<li>${error}</li>`;
            });
            html += '</ul></div>';
            uploadBtn.prop('disabled', true);
        } else {
            html += '<div class="alert alert-success">';
            html += '<h6><i class="fas fa-check-circle me-1"></i>数据验证通过</h6>';
            html += '<ul class="mb-0">';
            html += `<li>数据行数：${validation.row_count}</li>`;
            html += `<li>列数：${validation.column_count}</li>`;
            html += `<li>时间列：${validation.time_column_found ? '✓' : '✗'}</li>`;
            html += `<li>数据列匹配：${validation.data_columns_match ? '✓' : '✗'}</li>`;
            html += '</ul></div>';
            updateUploadButton();
        }

        if (validation.warnings && validation.warnings.length > 0) {
            html += '<div class="alert alert-warning"><h6>注意事项：</h6><ul class="mb-0">';
            validation.warnings.forEach(warning => {
                html += `<li>${warning}</li>`;
            });
            html += '</ul></div>';
        }

        $('#validationResult').html(html);
    }

    // 上传文件
    function uploadFile() {
        const file = fileInput[0].files[0];
        const name = dataName.val().trim();

        if (!file || !name) {
            showAlert('请选择文件并输入数据名称', 'warning');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('data_name', name);

        showProgress('正在上传文件...', 0);
        uploadBtn.prop('disabled', true);

        $.ajax({
            url: '{{ url_for("upload_data", experiment_type_id=experiment_type.id) }}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                const xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        updateProgress(percentComplete);
                    }
                });
                return xhr;
            },
            success: function(response) {
                hideProgress();
                if (response.success) {
                    showAlert('文件上传成功！', 'success');
                    setTimeout(() => {
                        window.location.href = '{{ url_for("envelope_analysis", experiment_type_id=experiment_type.id) }}';
                    }, 2000);
                } else {
                    showAlert(response.message || '上传失败', 'danger');
                    uploadBtn.prop('disabled', false);
                }
            },
            error: function() {
                hideProgress();
                showAlert('网络错误，上传失败', 'danger');
                uploadBtn.prop('disabled', false);
            }
        });
    }

    // 监听数据名称输入
    dataName.on('input', function() {
        updateUploadButton();
    });

    // 显示进度
    function showProgress(message, percent) {
        $('.progress-container').show();
        updateProgress(percent);
    }

    // 更新进度
    function updateProgress(percent) {
        $('#progressBar').css('width', percent + '%').attr('aria-valuenow', percent);
        $('#progressText').text(Math.round(percent) + '%');
    }

    // 隐藏进度
    function hideProgress() {
        $('.progress-container').hide();
    }

    // 格式化文件大小
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 显示提示信息
    function showAlert(message, type) {
        const alertClass = type === 'danger' ? 'alert-danger' : 
                          type === 'warning' ? 'alert-warning' : 'alert-success';
        
        const alert = $(`
            <div class="alert ${alertClass} alert-dismissible fade show">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('.upload-container').prepend(alert);
        
        setTimeout(() => {
            alert.alert('close');
        }, 5000);
    }
});
</script>
{% endblock %}
